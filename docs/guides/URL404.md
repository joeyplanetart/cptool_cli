# URL 404检测工具使用指南

## 概述

`cptools url404` 是一个用于批量检测 URL 状态码的工具,可以快速识别 404、500 等错误状态。

## 主要功能

- ✅ 批量检测 URL 状态码
- ✅ 识别 404 和 500 错误
- ✅ 生成可视化 HTML 报告(列表形式)
- ✅ 支持并发检测
- ✅ 自动在浏览器中打开报告
- ✅ 钉钉通知支持
- ✅ 完整日志记录

## 基本用法

```bash
cptools url404 --host <主机地址> --csv <CSV文件>
```

## 命令选项

| 选项 | 说明 | 默认值 | 必需 |
|------|------|--------|------|
| `--host`, `-h` | 默认主机地址 | - | 是 |
| `--csv` | CSV 文件路径 | - | 是 |
| `--log`, `-l` | 日志文件路径 | `./logs/url404_YYYYMMDD_HHMMSS.log` | 否 |
| `--html` | HTML 报告路径 | `./url404_result.html` | 否 |
| `-c`, `--concurrency` | 并发数量 | 5 | 否 |
| `--timeout` | 超时时间(毫秒) | 30000 | 否 |
| `--dingding-webhook` | 钉钉 Webhook | 已配置 | 否 |
| `--dingding-secret` | 钉钉签名密钥 | 已配置 | 否 |

## CSV 文件格式

CSV 文件应包含以下列:

```csv
PTN_NO,PRODUCT_ID,URL
1,产品名称1,+product-url-1
2,产品名称2,/full/path/product-2
3,产品名称3,https://example.com/product-3
```

**支持的列名(不区分大小写):**
- `url` 或 `URL`: URL地址(必需)
- `name`、`PRODUCT_ID`、`product_id`、`title` 或 `TITLE`: URL名称(可选)

## 使用示例

### 1. 基本检测

```bash
cptools url404 --host http://www.cafepress.com --csv test_10.csv
```

### 2. 自定义输出路径

```bash
cptools url404 \
  --host http://www.cafepress.com \
  --csv test_10.csv \
  --html ./reports/url404_result.html
```

### 3. 高并发检测

```bash
cptools url404 \
  --host http://www.cafepress.com \
  --csv test_10.csv \
  -c 10
```

### 4. 完整配置

```bash
cptools url404 \
  --host http://www.cafepress.com \
  --csv test_10.csv \
  --html ./reports/url404_result.html \
  --log ./logs/url404_check.log \
  -c 10 \
  --timeout 60000
```

### 5. 使用短参数

```bash
cptools url404 -h http://example.com --csv urls.csv -c 10 -l check.log
```

## HTML 报告功能

生成的 HTML 报告包含以下功能:

### 📊 统计信息
- 总数
- 成功数(2xx-3xx)
- 404 错误数
- 500+ 错误数
- 其他错误数

### 🔍 过滤功能
- 全部
- 成功
- 404
- 错误

### 🔎 搜索功能
- 按 URL 搜索
- 按名称搜索

### 📋 列表显示
- 序号
- 名称(带状态图标)
- URL(可点击)
- 状态码(彩色徽章)
- 状态信息和错误详情

### 🎨 视觉特性
- 不同状态的颜色区分
  - 绿色: 成功(2xx-3xx)
  - 黄色: 警告(404)
  - 红色: 错误(500+)
- 响应式设计
- 悬停效果
- 回到顶部按钮

## 状态码说明

| 状态码范围 | 说明 | 图标 |
|-----------|------|------|
| 200-399 | 成功 | ✓ |
| 404 | 页面不存在 | ⚠ |
| 500+ | 服务器错误 | ✗ |
| 其他 | 客户端错误 | ⚠ |
| NULL | 无法获取响应 | ✗ |

## 日志文件

日志文件记录所有检测过程:

```
2025-12-29 14:39:50 - cptools - INFO - 开始执行URL 404检测任务
2025-12-29 14:39:52 - cptools - INFO - [1] 开始检测: http://www.cafepress.com/...
2025-12-29 14:39:57 - cptools - INFO - [1] 检测成功 [200]: http://www.cafepress.com/...
2025-12-29 14:40:03 - cptools - INFO - URL 404检测任务完成
```

## 钉钉通知

任务完成后会自动发送钉钉通知,包含:

- 执行时间
- 总数和各类结果统计
- 执行耗时
- 主机地址
- CSV 文件名

## 性能优化建议

1. **并发数设置**
   - 本地测试: `-c 5-10`
   - 生产环境: `-c 3-5`
   - 高性能服务器: `-c 10-20`

2. **超时时间**
   - 快速网络: `--timeout 15000`(15秒)
   - 慢速网络: `--timeout 60000`(60秒)
   - 默认值: `30000`(30秒)

3. **大批量检测**
   - 分批处理 CSV 文件
   - 使用适当的并发数
   - 监控系统资源

## 常见问题

### Q: 如何只检测失败的 URL?

A: 先运行完整检测,然后在 HTML 报告中使用过滤功能查看失败项。

### Q: 可以导出失败的 URL 列表吗?

A: 当前版本在 HTML 报告中显示所有结果,可以在浏览器中复制失败项。

### Q: 超时错误如何处理?

A: 增加 `--timeout` 值或检查网络连接。

### Q: 如何禁用钉钉通知?

A: 暂不支持禁用,但可以使用无效的 webhook 地址。

## 与 screenshot 命令的区别

| 特性 | screenshot | url404 |
|------|-----------|--------|
| 主要功能 | 网页截图 | 状态码检测 |
| 输出 | PNG图片 | 无图片 |
| HTML报告 | 卡片式 | 列表式 |
| 检测速度 | 较慢(需渲染) | 较快 |
| 显示内容 | 截图预览 | 状态码 |

## 技术细节

- 基于 Playwright 浏览器自动化
- 使用 Chromium 无头模式
- 支持 HTTPS 错误忽略
- 随机延迟模拟人类行为
- 异步并发执行

## 示例输出

```
================================================================================
URL 404检测任务完成
总数: 10
成功(2xx-3xx): 8
404错误: 1
500错误: 0
其他错误: 1
耗时: 12.89秒
================================================================================
```

## 获取帮助

```bash
# 查看命令帮助
cptools url404 --help

# 查看版本
cptools --version

# 查看所有命令
cptools --help
```

## 相关文档

- [README.md](../README.md) - 项目总览
- [快速开始指南](docs/getting-started/QUICKSTART.md)
- [screenshot 命令文档](docs/guides/SCREENSHOT.md)

